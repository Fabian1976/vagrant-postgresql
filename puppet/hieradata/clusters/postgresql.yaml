---
roles:
  - core::role::postgresql::server

postgresql_datadir:      &postgresql_datadir      '/database'
postgresql_instancename: &postgresql_instancename 'mdt_cmc'
postgresql_masternode:   &postgresql_masternode   'pgdb01.mdt-cmc.local'

core::profile::copy::files:
  'archive_location':
    ensure: 'directory'
    path: "%{hiera('postgresql_datadir')}/%{hiera('postgresql_instancename')}/archive"
    owner: 'postgres'
    group: 'postgres'
    require: Class[Postgresql::Server::Install]
  'pgpass':
    ensure: file
    path: '/var/lib/pgsql/.pgpass'
    content: '*:*:replication:replication:replication'
    owner: 'postgres'
    group: 'postgres'
    mode: '0600'
    require: Class[Postgresql::Server::Install]

core::profile::postgresql::server::dbversion:              '9.6'
core::profile::postgresql::server::manage_repo:            true
core::profile::postgresql::server::use_seperate_partition: true
core::profile::postgresql::server::datadir:                *postgresql_datadir
core::profile::postgresql::server::instancename:           *postgresql_instancename
core::profile::postgresql::server::masternode:             *postgresql_masternode
core::profile::postgresql::server::slaves:                 1
core::profile::postgresql::server::synchronous_slave_names:
  - 's2'
core::profile::postgresql::server::pg_hba_rules:
  'replication':
    type: 'host'
    database: 'replication'
    user : 'replication'
    address: '10.10.10.0/24'
    auth_method: 'md5'

postgresql::server::log_line_prefix: '%t %u@%d %p '
postgresql::server::timezone:        'Europe/Amsterdam'
core::profile::postgresql::server::config_entries:
  'wal_level':
    value: 'replica'
  'fsync':
    value: 'on'
  'synchronous_commit':
    value: 'on'
  'log_timezone':
    value: 'Europe/Amsterdam'
  'log_filename':
    value: 'postgresql-%Y-%m-%d.log'
  'archive_mode':
    value: 'on'
  'archive_command':
    value: "test ! -f %{hiera('postgresql_datadir')}/%{hiera('postgresql_instancename')}/archive/%f && cp %p %{hiera('postgresql_datadir')}/%{hiera('postgresql_instancename')}/archive/%f"
  'max_wal_senders':
    value: '5'
  'wal_keep_segments':
    value: '32'
  'hot_standby':
    value: 'on'

postgresql::server::roles:
  'replication':
    replication: true
    password_hash: 'replication'
    require: Class[Postgresql::Server::Service]
